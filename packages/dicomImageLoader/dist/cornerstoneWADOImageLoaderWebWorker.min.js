/*! cornerstone-wado-image-loader - v0.14.3 - 2017-04-19 | (c) 2014 Chris Hafey | https://github.com/chafey/cornerstoneWADOImageLoader */

"use strict";cornerstoneWADOImageLoaderWebWorker={registerTaskHandler:void 0},function(){function a(a){if(!e){if(c=a.config,a.config.webWorkerTaskPaths)for(var b=0;b<a.config.webWorkerTaskPaths.length;b++)self.importScripts(a.config.webWorkerTaskPaths[b]);Object.keys(d).forEach(function(a){d[a].initialize(c.taskConfiguration)}),self.postMessage({taskType:"initialize",status:"success",result:{},workerIndex:a.workerIndex}),e=!0}}function b(a){c=a.config,self.importScripts(a.sourcePath)}var c,d={},e=!1;cornerstoneWADOImageLoaderWebWorker.registerTaskHandler=function(a){if(d[a.taskType])return console.log('attempt to register duplicate task handler "',a.taskType,'"'),!1;d[a.taskType]=a,e&&a.initialize(c.taskConfiguration)},self.onmessage=function(c){return"initialize"===c.data.taskType?void a(c.data):"loadWebWorkerTask"===c.data.taskType?void b(c.data):d[c.data.taskType]?void d[c.data.taskType].handler(c.data,function(a,b){self.postMessage({taskType:c.data.taskType,status:"success",result:a,workerIndex:c.data.workerIndex},b)}):(console.log("no task handler for ",c.data.taskType),console.log(d),void self.postMessage({taskType:c.data.taskType,status:"failed - no task handler registered",workerIndex:c.data.workerIndex}))}}(),cornerstoneWADOImageLoader={},function(){function a(a){f||(self.importScripts(a.decodeTask.codecsPath),f=!0,a.decodeTask.initializeCodecsOnStartup&&(cornerstoneWADOImageLoader.initializeJPEG2000(a.decodeTask),cornerstoneWADOImageLoader.initializeJPEGLS(a.decodeTask)))}function b(b){e=b,b.decodeTask.loadCodecsOnStartup&&a(b)}function c(a){if(void 0===a.smallestPixelValue||void 0===a.largestPixelValue){var b=cornerstoneWADOImageLoader.getMinMax(a.pixelData);a.smallestPixelValue=b.min,a.largestPixelValue=b.max}}function d(b,d){a(e);var f=b.data.imageFrame,g=new Uint8Array(b.data.pixelData);cornerstoneWADOImageLoader.decodeImageFrame(f,b.data.transferSyntax,g,e.decodeTask,b.data.options),c(f),f.pixelData=f.pixelData.buffer,d(f,[f.pixelData])}var e,f=!1;cornerstoneWADOImageLoaderWebWorker.registerTaskHandler({taskType:"decodeTask",handler:d,initialize:b})}(),function(a){function b(b,c,d,e,f){var g=(new Date).getTime();if("1.2.840.10008.1.2"===c)b=a.decodeLittleEndian(b,d);else if("1.2.840.10008.1.2.1"===c)b=a.decodeLittleEndian(b,d);else if("1.2.840.10008.1.2.2"===c)b=a.decodeBigEndian(b,d);else if("1.2.840.10008.1.2.1.99"===c)b=a.decodeLittleEndian(b,d);else if("1.2.840.10008.1.2.5"===c)b=a.decodeRLE(b,d);else if("1.2.840.10008.1.2.4.50"===c)b=a.decodeJPEGBaseline(b,d);else if("1.2.840.10008.1.2.4.51"===c)b=a.decodeJPEGBaseline(b,d);else if("1.2.840.10008.1.2.4.57"===c)b=a.decodeJPEGLossless(b,d);else if("1.2.840.10008.1.2.4.70"===c)b=a.decodeJPEGLossless(b,d);else if("1.2.840.10008.1.2.4.80"===c)b=a.decodeJPEGLS(b,d);else if("1.2.840.10008.1.2.4.81"===c)b=a.decodeJPEGLS(b,d);else if("1.2.840.10008.1.2.4.90"===c)b=a.decodeJPEG2000(b,d,e,f);else{if("1.2.840.10008.1.2.4.91"!==c)throw console&&console.log&&console.log("Image cannot be decoded due to Unsupported transfer syntax "+c),"no decoder for transfer syntax "+c;b=a.decodeJPEG2000(b,d,e,f)}var h=(new Date).getTime();return b.decodeTimeInMS=h-g,b}a.decodeImageFrame=b}(cornerstoneWADOImageLoader),function(a){function b(a){return(255&a)<<8|a>>8&255}function c(a,c){if(16===a.bitsAllocated){var d=c.buffer,e=c.byteOffset,f=c.length;e%2&&(d=d.slice(e),e=0),0===a.pixelRepresentation?a.pixelData=new Uint16Array(d,e,f/2):a.pixelData=new Int16Array(d,e,f/2);for(var g=0;g<a.pixelData.length;g++)a[g]=b(a.pixelData[g])}else 8===a.bitsAllocated&&(a.pixelData=c);return a}a.decodeBigEndian=c}(cornerstoneWADOImageLoader),function(a){function b(a,b){var c=new JpxImage;c.parse(b);var d=c.tiles.length;if(1!==d)throw"JPEG2000 decoder returned a tileCount of "+d+", when 1 is expected";return a.columns=c.width,a.rows=c.height,a.pixelData=c.tiles[0].items,a}function c(a,b,c){var d=g._malloc(a.length);g.writeArrayToMemory(a,d);var e=g._malloc(4),f=g._malloc(4),h=g._malloc(4),i=g._malloc(4),j=g._malloc(4),k=Date.now();if(0!==g.ccall("jp2_decode","number",["number","number","number","number","number","number","number"],[d,a.length,e,f,h,i,j]))return console.log("[opj_decode] decoding failed!"),g._free(d),g._free(g.getValue(e,"*")),g._free(h),g._free(i),g._free(f),void g._free(j);var l=g.getValue(e,"*"),m={length:g.getValue(f,"i32"),sx:g.getValue(h,"i32"),sy:g.getValue(i,"i32"),nbChannels:g.getValue(j,"i32"),perf_timetodecode:void 0,pixelData:void 0},n=m.sx*m.sy*m.nbChannels,o=new Int32Array(g.HEAP32.buffer,l,n);if(1===b)if(Uint8Array.from)m.pixelData=Uint8Array.from(o);else{m.pixelData=new Uint8Array(n);for(var p=0;p<n;p++)m.pixelData[p]=o[p]}else if(c)if(Int16Array.from)m.pixelData=Int16Array.from(o);else{m.pixelData=new Int16Array(n);for(var p=0;p<n;p++)m.pixelData[p]=o[p]}else if(Uint16Array.from)m.pixelData=Uint16Array.from(o);else{m.pixelData=new Uint16Array(n);for(var p=0;p<n;p++)m.pixelData[p]=o[p]}var q=Date.now();return m.perf_timetodecode=q-k,g._free(d),g._free(e),g._free(l),g._free(f),g._free(h),g._free(i),g._free(j),m}function d(a,b){var d=a.bitsAllocated<=8?1:2,e=1===a.pixelRepresentation,f=c(b,d,e);return a.columns=f.sx,a.rows=f.sy,a.pixelData=f.pixelData,f.nbChannels>1&&(a.photometricInterpretation="RGB"),a}function e(a){if(!a.usePDFJS&&"undefined"==typeof OpenJPEG)throw"OpenJPEG decoder not loaded";if(!(g||(g=OpenJPEG())&&g._jp2_decode))throw"OpenJPEG failed to initialize"}function f(a,c,f,g){return g=g||{},e(f),g.usePDFJS||f.usePDFJS?b(a,c):d(a,c)}var g;a.decodeJPEG2000=f,a.initializeJPEG2000=e}(cornerstoneWADOImageLoader),function(a){function b(a,b){if("undefined"==typeof JpegImage)throw"No JPEG Baseline decoder loaded";var c=new JpegImage;return c.parse(b),c.colorTransform=!1,8===a.bitsAllocated?(a.pixelData=c.getData(a.columns,a.rows),a):16===a.bitsAllocated?(a.pixelData=c.getData16(a.columns,a.rows),a):void 0}a.decodeJPEGBaseline=b}(cornerstoneWADOImageLoader),function(a){function b(a,b){if("undefined"==typeof jpeg||void 0===jpeg.lossless||void 0===jpeg.lossless.Decoder)throw"No JPEG Lossless decoder loaded";var c=a.bitsAllocated<=8?1:2,d=b.buffer,e=new jpeg.lossless.Decoder,f=e.decode(d,b.byteOffset,b.length,c);return 0===a.pixelRepresentation?16===a.bitsAllocated?(a.pixelData=new Uint16Array(f.buffer),a):(a.pixelData=new Uint8Array(f.buffer),a):(a.pixelData=new Int16Array(f.buffer),a)}a.decodeJPEGLossless=b}(cornerstoneWADOImageLoader),function(a){function b(a,b){var c=e._malloc(a.length);e.writeArrayToMemory(a,c);var d=e._malloc(4),f=e._malloc(4),g=e._malloc(4),h=e._malloc(4),i=e._malloc(4),j=e._malloc(4),k=e._malloc(4),l=e._malloc(4),m=e._malloc(4),n=e.ccall("jpegls_decode","number",["number","number","number","number","number","number","number","number","number","number","number"],[c,a.length,d,f,g,h,i,j,l,k,m]),o={result:n,width:e.getValue(g,"i32"),height:e.getValue(h,"i32"),bitsPerSample:e.getValue(i,"i32"),stride:e.getValue(j,"i32"),components:e.getValue(l,"i32"),allowedLossyError:e.getValue(k,"i32"),interleaveMode:e.getValue(m,"i32"),pixelData:void 0},p=e.getValue(d,"*");return o.bitsPerSample<=8?(o.pixelData=new Uint8Array(o.width*o.height*o.components),o.pixelData.set(new Uint8Array(e.HEAP8.buffer,p,o.pixelData.length))):b?(o.pixelData=new Int16Array(o.width*o.height*o.components),o.pixelData.set(new Int16Array(e.HEAP16.buffer,p,o.pixelData.length))):(o.pixelData=new Uint16Array(o.width*o.height*o.components),o.pixelData.set(new Uint16Array(e.HEAP16.buffer,p,o.pixelData.length))),e._free(c),e._free(p),e._free(d),e._free(f),e._free(g),e._free(h),e._free(i),e._free(j),e._free(l),e._free(m),o}function c(){if("undefined"==typeof CharLS)throw"No JPEG-LS decoder loaded";if(!(e||(e=CharLS())&&e._jpegls_decode))throw"JPEG-LS failed to initialize"}function d(a,d){c();var e=b(d,1===a.pixelRepresentation);if(0!==e.result&&6!==e.result)throw"JPEG-LS decoder failed to decode frame (error code "+e.result+")";return a.columns=e.width,a.rows=e.height,a.pixelData=e.pixelData,a}var e;a.decodeJPEGLS=d,a.initializeJPEGLS=c}(cornerstoneWADOImageLoader),function(a){function b(a,b){if(16===a.bitsAllocated){var c=b.buffer,d=b.byteOffset,e=b.length;d%2&&(c=c.slice(d),d=0),0===a.pixelRepresentation?a.pixelData=new Uint16Array(c,d,e/2):a.pixelData=new Int16Array(c,d,e/2)}else 8===a.bitsAllocated&&(a.pixelData=b);return a}a.decodeLittleEndian=b}(cornerstoneWADOImageLoader),function(a){function b(a,b){if(8===a.bitsAllocated)return c(a,b);if(16===a.bitsAllocated)return d(a,b);throw"unsupported pixel format for RLE"}function c(a,b){for(var c=b,d=a.rows*a.columns,e=new ArrayBuffer(d*a.samplesPerPixel),f=new DataView(c.buffer,c.byteOffset),g=new Int8Array(c.buffer,c.byteOffset),h=new Int8Array(e),i=0,j=f.getInt32(0,!0),k=0;k<j;++k){i=k;var l=f.getInt32(4*(k+1),!0),m=f.getInt32(4*(k+2),!0);0===m&&(m=c.length);for(var n=d*j;l<m;){var o=g[l++];if(o>=0&&o<=127)for(var p=0;p<o+1&&i<n;++p)h[i]=g[l++],i+=a.samplesPerPixel;else if(o<=-1&&o>=-127)for(var q=g[l++],r=0;r<1-o&&i<n;++r)h[i]=q,i+=a.samplesPerPixel}}return a.pixelData=new Uint8Array(e),a}function d(a,b){for(var c=b,d=a.rows*a.columns,e=new ArrayBuffer(d*a.samplesPerPixel*2),f=new DataView(c.buffer,c.byteOffset),g=new Int8Array(c.buffer,c.byteOffset),h=new Int8Array(e),i=f.getInt32(0,!0),j=0;j<i;++j){var k=0,l=0===j?1:0,m=f.getInt32(4*(j+1),!0),n=f.getInt32(4*(j+2),!0);for(0===n&&(n=c.length);m<n;){var o=g[m++];if(o>=0&&o<=127)for(var p=0;p<o+1&&k<d;++p)h[2*k+l]=g[m++],k++;else if(o<=-1&&o>=-127)for(var q=g[m++],r=0;r<1-o&&k<d;++r)h[2*k+l]=q,k++}}return 0===a.pixelRepresentation?a.pixelData=new Uint16Array(e):a.pixelData=new Int16Array(e),a}a.decodeRLE=b}(cornerstoneWADOImageLoader),function(a){function b(a){for(var b,c=a[0],d=a[0],e=a.length,f=1;f<e;f++)b=a[f],c=Math.min(c,b),d=Math.max(d,b);return{min:c,max:d}}a.getMinMax=b}(cornerstoneWADOImageLoader);